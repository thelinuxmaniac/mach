<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Analysis of Code Evolution (ACE)</title>
  </head>
  <body>
    <h1>Analysis of Code Evolution (ACE)</h1>
    <ol id="commit_list"></ol>
  </body>

  <script>
    const REPO_BASEURL = './repo/';
    const REPO_NAME = 'coreutils.git';
    const TAG_NAME = 'refs/tags/v8.3';
    var TAG_SHA = '';
    var repo_url = REPO_BASEURL + REPO_NAME;

    fetch_repo(repo_url);

    function fetch_repo(repo_url) {
      const packed_ref_url = repo_url + '/packed-refs';
      fetch(packed_ref_url, {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'text/plain',
        },
      }).then( function(response) {
        return response.text();
      }).then( function(data) {
        const packed_ref_tok = data.split('\n');
        const line_count = packed_ref_tok.length;
        for(var i=0; i<line_count; ++i) {
          const line = packed_ref_tok[i];
          const line_tok = line.split(' ');
          if(line_tok.length === 2) {
            if(line_tok[1] === TAG_NAME) {
              TAG_SHA = line_tok[0];
              console.log('match found: tag=' + TAG_NAME + ', sha=' + TAG_SHA);
              fetch_all_pack();
            }
          }
          //console.log('[' + i + ']' + packed_ref_tok[i]);
        }
      }).catch( function(err) {
        console.error(err);
      });
    }

    function fetch_all_pack() {
      const pack_list_url = repo_url + '/objects/pack/';
      fetch(pack_list_url, {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'text/plain',
        },
      }).then( function(response) {
        return response.text();
      }).then( function(data) {
        const html = document.createElement('html');
        html.innerHTML = data;
        const links = html.getElementsByTagName('a');
        const link_count = links.length;
        var pack_sha_list = [];
        for(var i=0; i<link_count; ++i) {
          const href = links[i].getAttribute('href');
          const label = links[i].innerHTML;
          if(label.startsWith('pack-')) {
            if(label.endsWith('.idx') || label.endsWith('.pack')) {
              const dash_index = label.indexOf('-');
              const dot_index = label.indexOf('.');
              const pack_sha = label.substring(dash_index+1, dot_index);
              if( pack_sha_list.indexOf(pack_sha) === -1 ) {
                pack_sha_list.push(pack_sha);
              }
            }
          }
        }
        console.log(pack_sha_list);
        for(const pack_sha_index in pack_sha_list) {
          const pack_sha = pack_sha_list[pack_sha_index];
          fetch_pack(pack_sha);
        }
      });
    }

    function fetch_pack(pack_sha) {
      console.log('fetching pack ' + pack_sha);
      const pack_index_url = repo_url + '/objects/pack/pack-' + pack_sha + '.idx';
      fetch(pack_index_url, {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/octet-stream',
          'Content-Transfer-Encoding': 'binary',
        },
      }).then( function(response) {
        return response.arrayBuffer();
      }).then( function(array_buffer) {
        parse_pack_index(array_buffer);
      });
    }

    // References
    // https://github.com/git/git/blob/bcb6cae2966cc407ca1afc77413b3ef11103c175/builtin/show-index.c
    // https://github.com/git/git/blob/bcb6cae2966cc407ca1afc77413b3ef11103c175/pack.h
    function parse_pack_index(array_buffer) {
      const PACK_IDX_SIGNATURE = 0xff744f63;

      // assert the signature
      const four_byte_view = new Uint32Array(array_buffer);
      console.log(four_byte_view[0])
      console.log(Number('0xff744f63'))
      console.assert( four_byte_view[0] === Number('0xff744f63'),
                      'Invalid signature found in pack index');
      //
      const byteArray = new Uint8Array(array_buffer);
      for(var i=0; i<byteArray.length; ++i) {
        console.log('[' + i + '] ' + byteArray[i] + ' : ' + String.fromCharCode(byteArray[i]));
        if(i > 10) {
          break;
        }
      }
    }
  </script>
</html>
