<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="author" content="Abhishek Dutta">
    <meta name="description" content="A software tool to manually annotate and analyse the evolution of software program code contained in a code repository.">
    <!-- turn off caching for debugging -->
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>Manual Annotation of Code History (MACH)</title>
    <link rel="stylesheet" href="mach.css" />
  </head>
  <body>
    <div id="mach_container"></div>
  </body>

  <script src="git.js"></script>
  <script src="mach.js"></script>

  <script>
    if(!window.DecompressionStream) {
      // TODO: use zlib library (Javascript version) to inflate the data
      const error_msg = 'Upgrade your browser to the latest version (e.g. Firefox 113, Chrome 80) because the DecompressionStream API not available this browser which is required to inflate zlib compressed objects stored in git pack files.';
      window.alert(error_msg);
      throw new Error(error_msg);
    }

    const mach = new _mach();
    const mach_container = document.getElementById('mach_container');
    mach.init(mach_container);

    // for debugging
    const REPO_BASEURL      = '../repo/';
    const REPO_NAME         = 'coreutils.git';
    this.selected_tag_name = 'refs/tags/v8.3';
    const repo_url = REPO_BASEURL + REPO_NAME;
    mach.load_code_repo(repo_url).then(function(repo_stat) {
      const tag_count = repo_stat.tag_count;
      const obj_count = repo_stat.pack_obj_count;
      console.log('loaded repo with ' + tag_count + ' tags and ' + obj_count + ' objects');

      mach.git.load_all_commit().then( function(loaded_commit_count) {
        const COMMIT_COUNT = loaded_commit_count;
        const last_commit_id = mach.git.commit_id_sorted_list[COMMIT_COUNT-1][0];
        console.log('last commit id ' + last_commit_id + ', index=' + mach.git.commit_id_sorted_list[COMMIT_COUNT-1][1]);
        const tree_id = mach.git.commit[last_commit_id]['tree'];
        mach.git.load_tree(tree_id, []).then(function(merged_paths) {
          mach.ui_init();
          mach.update_source_tree();
        }.bind(this), function(err_tree) {
          mach.log('Error: failed to load tree contents (' + err_tree + ')');
        });
      }.bind(this), function(err_commit) {
        mach.log('Error: failed to load commits (' + err_commit + ')');
      });
    }.bind(this), function(err_repo) {
      mach.log('Error: ' + err_repo);
    }.bind(this));
  </script>
</html>
